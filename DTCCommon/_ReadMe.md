DTCCommon
=========

-   DTCCommon contains classes that are used by both DTClient and DTCServer

-   Classes are generated by protoc.

-   DTC refers to the Sierra Chart protocol at DTCProtocol.org

Speed tests 7/27/2021 reading QQQ 1T records from DTC Historical
----------------------------------------------------------------
All are running in Release mode:
* Protocol buffers 6,492,777 records in 17,516 ms
* Binary not zipped 6,492,777 records in 21,893 ms
* Binary zipped 6,492,777 records in 15,936 ms
* So in Release mode, zipped binary is maybe 10% faster than ProtocolBuffers. This transmission is on a local machine, and compression is likely to be much more beneficial acoss the internet.

Inheritance
-----------

ClientDTC derives from TcpClient.
ListenerDTC derives from TcpListener.
A service, e.g. ExampleService, is implemented by deriving from ListenerDTC and implementing its abstract method HandleRequestAsync()

DTC basic logic both client and client handler
----------------------------------------------------------------
READ LOOP
Read a message type and bytes from the input stream. 
Call preprocessor method to handle a few messages types immediately.
Use a decode func to convert the message to Protobuf
If preprocessor didn't handle the message, add it to the queue

PROCESSOR LOOP
Take message from queue
Call processor method

PROCESS METHOD
Client: Send the message to an event or multiple events
ClientHandler: Handle the request to build a response messag. Use the encode func to change get the correct bytes for the current encoding,  then write the bytes to the output stream
Sometimes may take another action, e.g. switch encode and decode funcs when encoding response changes encoding

Any exception,  including user cancellation, closes the class
Close is the same as Dispose.
Disconnect event always thrown by Dispose, and is only thrown by Dispose

Processor method in client only handles responses.
Processor method in clientHandler only handles requests.

FUNCs
Decode func converts bytes to IMessage from a particular protocol, like binary or Json or protobuf
Encode func converts IMessage to bytes per a particular protocol, like binary or Json or protobuf

STREAMS
_currentStreams is the tcpClient.NetworkStream, but compression switches it  to a DeflateStream for receiving and sending compressed historical data records. The service should end the compression when the last record is sent, allowing the client to resume processing other messages. Unlike SierraChart, DTCSharp supports compression of any encoding and does not distinguish between a historical client and any other client.

HEARTBEATS
Each heartbeat received is preprocessed (not queued) by recording the last heartbeat received timestamp
Heartbeat timer runs every second
Closes (Disposes) if after twice the heartbeat interval since last message received timestamp
Sends a heartbeat and records the sent timestamp if after the last heartbeat sent timestamp

DTC_LOGON_REQUEST_INTEGER_1 Documentation
-----------------------------------------

From https://www.sierrachart.com/SupportBoard.php?PostID=192350#P192350

const unsigned int DTC_LOGON_REQUEST_INTEGER_1_LOW_BANDWIDTH_FLAG = 0x1;
const unsigned int DTC_LOGON_REQUEST_INTEGER_1_RELAY_SERVER_MODE = 0x2;
const unsigned int DTC_LOGON_REQUEST_INTEGER_1_SUPPORT_UNBUNDLED_TRADES = 0x4;
const unsigned int DTC_LOGON_REQUEST_INTEGER_1_NO_COMPACT_MARKET_DATA_MESSAGES = 0x8;

From https://www.sierrachart.com/SupportBoard.php?ThreadID=47383, now the default
const unsigned int DTC_LOGON_REQUEST_INTEGER_1_USE_MARKET_DEPTH_UPDATE_FLOAT_WITH_MS_MESSAGES = 0x80;